name: LMS CI/CD
on:
  push:
    branches:
      - main
permissions:
  contents: read
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    # Step 1 - Checkout code
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Step 2 - Log in to Azure
    - name: Log in to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    # Step 3 - Log in to ACR
    - name: Log in to ACR
      run: |
        az acr login --name lmsacr001
    
    # Step 4 - Build Docker image
    - name: Build Docker image
      run: |
        docker build -t lmsacr001.azurecr.io/lms:latest ./library-management-system
    
    # Step 5 - Push image to ACR
    - name: Push Docker image
      run: |
        docker push lmsacr001.azurecr.io/lms:latest
    
    # Step 6 - Delete existing container instance
    - name: Delete existing container instance
      run: |
        az container delete \
          --resource-group LIB1 \
          --name lms-app \
          --yes
      continue-on-error: true
    
    # Step 7 - Create new container instance
    - name: Create container instance with updated image
      run: |
        az container create \
          --resource-group LIB1 \
          --name lms-app \
          --image lmsacr001.azurecr.io/lms:latest \
          --registry-login-server lmsacr001.azurecr.io \
          --registry-username ${{ secrets.ACR_USERNAME }} \
          --registry-password ${{ secrets.ACR_PASSWORD }} \
          --dns-name-label lms-app-unique \
          --ports 80 \
          --cpu 1 \
          --memory 1.5 \
          --os-type Linux
